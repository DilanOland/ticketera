<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tickets - OLAND SEGUROS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-white: #ffffff;
            --primary-dark-blue: #0b2240;
            --primary-red: #9f202b;
            --light-gray: #f8fafc;
            --medium-gray: #e2e8f0;
            --dark-gray: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --cyan: #06b6d4;
            
            --gradient-primary: linear-gradient(135deg, #0b2240 0%, #1e3a8a 100%);
            --gradient-secondary: linear-gradient(135deg, #9f202b 0%, #dc2626 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            --gradient-card: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            --radius-sm: 8px;
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--light-gray);
            color: var(--primary-dark-blue);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animaciones */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Scroll personalizado */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-dark-blue);
            border-radius: 10px;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--gradient-primary);
            color: var(--primary-white);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: var(--transition);
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(11, 34, 64, 0.9);
        }

        .logo {
            width: 50px;
            height: 50px;
            background: var(--primary-white);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--primary-red);
            font-size: 1.4rem;
            box-shadow: var(--shadow-lg);
            animation: float 6s ease-in-out infinite;
        }

        .logo-text h2 {
            font-size: 1.4rem;
            font-weight: 800;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-section {
            padding: 0 25px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            font-weight: 600;
        }

        .menu-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            text-decoration: none;
            color: var(--primary-white);
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: var(--primary-red);
        }

        .menu-item.active {
            background: rgba(159, 32, 43, 0.15);
            border-left-color: var(--primary-red);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .menu-badge {
            background: var(--primary-red);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 300px;
            padding: 0;
            background: var(--light-gray);
        }

        .header {
            background: var(--primary-white);
            padding: 20px 30px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            color: var(--dark-gray);
            font-size: 1rem;
            margin-top: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--gradient-primary);
            color: var(--primary-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: var(--shadow);
        }

        /* Sistema de Tickets */
        .tickets-container {
            padding: 30px;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            height: calc(100vh - 80px);
        }

        /* Panel de Creación */
        .create-ticket-panel {
            background: var(--primary-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--medium-gray);
        }

        .panel-header {
            margin-bottom: 25px;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .panel-subtitle {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark-blue);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--medium-gray);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--primary-white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-dark-blue);
            box-shadow: 0 0 0 3px rgba(11, 34, 64, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: 'Inter', sans-serif;
        }

        .priority-selector {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .priority-option {
            padding: 15px 10px;
            border: 2px solid var(--medium-gray);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .priority-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .priority-option.active {
            border-color: var(--primary-red);
            background: rgba(159, 32, 43, 0.05);
            color: var(--primary-red);
        }

        .priority-option.low.active {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
            color: var(--success);
        }

        .priority-option.medium.active {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
            color: var(--warning);
        }

        .priority-option.high.active {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
            color: var(--danger);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--primary-white);
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: var(--gradient-success);
            color: var(--primary-white);
            box-shadow: var(--shadow);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Lista de Tickets */
        .tickets-list-panel {
            background: var(--primary-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--medium-gray);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .list-title {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ticket-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--medium-gray);
            border-radius: var(--radius);
            background: var(--primary-white);
            color: var(--dark-gray);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .filter-btn.active {
            border-color: var(--primary-dark-blue);
            background: var(--primary-dark-blue);
            color: white;
        }

        .export-btn {
            background: var(--gradient-success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            margin-left: 15px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .tickets-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ticket-card {
            background: var(--primary-white);
            border: 2px solid var(--medium-gray);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .ticket-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--dark-gray);
            transition: var(--transition);
        }

        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-dark-blue);
        }

        .ticket-card.high::before {
            background: var(--danger);
        }

        .ticket-card.medium::before {
            background: var(--warning);
        }

        .ticket-card.low::before {
            background: var(--success);
        }

        .ticket-card.completed {
            opacity: 0.7;
            background: var(--light-gray);
        }

        .ticket-card.completed .ticket-title {
            text-decoration: line-through;
            color: var(--dark-gray);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .ticket-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .ticket-priority {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .priority-low {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .ticket-description {
            color: var(--dark-gray);
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ticket-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--dark-gray);
        }

        .ticket-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ticket-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px;
            border: none;
            background: none;
            color: var(--dark-gray);
            cursor: pointer;
            transition: var(--transition);
            border-radius: var(--radius-sm);
        }

        .action-btn:hover {
            background: var(--light-gray);
            color: var(--primary-dark-blue);
        }

        /* Estados vacíos */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--dark-gray);
            animation: fadeIn 0.5s ease-out;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
            animation: bounce 2s infinite;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--primary-dark-blue);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        /* Modal de Exportación */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: var(--primary-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark-gray);
            cursor: pointer;
            transition: var(--transition);
            padding: 5px;
            border-radius: var(--radius-sm);
        }

        .modal-close:hover {
            background: var(--light-gray);
            color: var(--primary-dark-blue);
        }

        .modal-body {
            padding: 30px;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .export-option {
            padding: 20px;
            border: 2px solid var(--medium-gray);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .export-option:hover {
            border-color: var(--primary-dark-blue);
            transform: translateY(-2px);
        }

        .export-option i {
            font-size: 2rem;
            color: var(--primary-dark-blue);
        }

        .export-option-content h4 {
            margin-bottom: 5px;
            color: var(--primary-dark-blue);
        }

        .export-option-content p {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 25px;
            border-radius: var(--radius-lg);
            background: var(--primary-white);
            color: var(--primary-dark-blue);
            box-shadow: var(--shadow-xl);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(400px);
            transition: var(--transition);
            border-left: 4px solid var(--success);
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification i {
            font-size: 1.4rem;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Estadísticas */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--primary-white);
            padding: 25px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--medium-gray);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
        }

        .stat-icon.primary {
            background: var(--gradient-primary);
            color: white;
        }

        .stat-icon.success {
            background: var(--gradient-success);
            color: white;
        }

        .stat-icon.warning {
            background: var(--gradient-warning);
            color: white;
        }

        .stat-icon.danger {
            background: var(--gradient-secondary);
            color: white;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 5px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--dark-gray);
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 80px;
            }
            .sidebar-header h2, .menu-item span, .menu-section, .menu-badge {
                display: none;
            }
            .main-content {
                margin-left: 80px;
            }
            .menu-item {
                justify-content: center;
                padding: 20px;
            }
        }

        @media (max-width: 968px) {
            .tickets-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            .create-ticket-panel {
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .tickets-container {
                padding: 20px;
                gap: 20px;
            }
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .list-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .ticket-filters {
                width: 100%;
                justify-content: space-between;
            }
            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        /* Páginas */
        .page {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease-out;
        }

        .page.active {
            display: block;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: var(--dark-gray);
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <!-- Notificación -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <div>
            <div style="font-weight: 600;" id="notification-title">Éxito</div>
            <span id="notification-text">Ticket creado correctamente</span>
        </div>
    </div>

    <!-- Modal de Exportación -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Exportar Reporte</h2>
                <button class="modal-close" id="exportModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="ticketSystem.exportToExcel('all')">
                        <i class="fas fa-file-excel"></i>
                        <div class="export-option-content">
                            <h4>Reporte Completo</h4>
                            <p>Exportar todos los tickets con información detallada</p>
                        </div>
                    </div>
                    <div class="export-option" onclick="ticketSystem.exportToExcel('current')">
                        <i class="fas fa-filter"></i>
                        <div class="export-option-content">
                            <h4>Reporte Filtrado</h4>
                            <p>Exportar solo los tickets visibles con el filtro actual</p>
                        </div>
                    </div>
                    <div class="export-option" onclick="ticketSystem.exportToExcel('stats')">
                        <i class="fas fa-chart-pie"></i>
                        <div class="export-option-content">
                            <h4>Reporte Estadístico</h4>
                            <p>Exportar estadísticas y resúmenes de los tickets</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">OS</div>
                <div class="logo-text">
                    <h2>OLAND SEGUROS</h2>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Sistema de Tickets</div>
                </div>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-section">Navegación Principal</div>
                <a href="#tickets" class="menu-item active" data-page="tickets">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Mis Tickets</span>
                    <div class="menu-badge" id="ticketsCount">0</div>
                </a>
                <a href="#nuevo" class="menu-item" data-page="nuevo">
                    <i class="fas fa-plus-circle"></i>
                    <span>Nuevo Ticket</span>
                </a>
                
                <div class="menu-section">Reportes</div>
                <a href="#exportar" class="menu-item" id="exportBtn">
                    <i class="fas fa-file-export"></i>
                    <span>Exportar Reportes</span>
                </a>
                <a href="#estadisticas" class="menu-item" data-page="estadisticas">
                    <i class="fas fa-chart-bar"></i>
                    <span>Estadísticas</span>
                </a>
                
                <div class="menu-section">Organización</div>
                <a href="#pendientes" class="menu-item" data-page="pendientes">
                    <i class="fas fa-clock"></i>
                    <span>Pendientes</span>
                    <div class="menu-badge" id="pendientesCount">0</div>
                </a>
                <a href="#completados" class="menu-item" data-page="completados">
                    <i class="fas fa-check-circle"></i>
                    <span>Completados</span>
                    <div class="menu-badge" id="completadosCount">0</div>
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <h1 id="mainTitle">Sistema de Tickets</h1>
                    <div class="header-subtitle">
                        <span id="connectionStatus" style="display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-circle" style="color: var(--success); font-size: 0.7rem;"></i>
                            Conectado a Supabase
                        </span>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600;">Usuario Sistema</div>
                        <div style="font-size: 0.8rem; color: var(--dark-gray);">Administrador</div>
                    </div>
                </div>
            </div>

            <!-- Página de Tickets -->
            <div id="page-tickets" class="page active">
                <div class="tickets-container">
                    <!-- Panel de Creación -->
                    <div class="create-ticket-panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-plus-circle"></i>
                                Crear Nueva Novedad
                            </div>
                            <div class="panel-subtitle">Registra tus actividades y recordatorios importantes</div>
                        </div>

                        <form id="ticketForm">
                            <div class="form-group">
                                <label class="form-label" for="ticketTitle">
                                    <i class="fas fa-heading"></i>
                                    Título de la Novedad
                                </label>
                                <input type="text" id="ticketTitle" class="form-control" 
                                       placeholder="Ej: Reunión con cliente importante" 
                                       required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="ticketDescription">
                                    <i class="fas fa-align-left"></i>
                                    Descripción Detallada
                                </label>
                                <textarea id="ticketDescription" class="form-control" 
                                          placeholder="Describe tu novedad, actividad o recordatorio de manera clara y completa..." 
                                          required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-flag"></i>
                                    Nivel de Prioridad
                                </label>
                                <div class="priority-selector">
                                    <div class="priority-option low" data-priority="low">
                                        <i class="fas fa-arrow-down"></i>
                                        <span>Baja</span>
                                        <small style="font-size: 0.7rem; opacity: 0.7;">Rutina</small>
                                    </div>
                                    <div class="priority-option medium active" data-priority="medium">
                                        <i class="fas fa-minus"></i>
                                        <span>Media</span>
                                        <small style="font-size: 0.7rem; opacity: 0.7;">Importante</small>
                                    </div>
                                    <div class="priority-option high" data-priority="high">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>Alta</span>
                                        <small style="font-size: 0.7rem; opacity: 0.7;">Urgente</small>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
                                <i class="fas fa-paper-plane"></i>
                                Crear Ticket
                            </button>
                        </form>

                        <!-- Sección de Exportación Rápida -->
                        <div style="margin-top: auto; padding-top: 20px;">
                            <div style="background: var(--light-gray); padding: 20px; border-radius: var(--radius);">
                                <div style="font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-file-export" style="color: var(--success);"></i>
                                    Exportación Rápida
                                </div>
                                <p style="font-size: 0.9rem; color: var(--dark-gray); margin-bottom: 15px;">
                                    Exporta tus tickets a Excel con diseños profesionales
                                </p>
                                <button class="btn btn-success btn-block" onclick="ticketSystem.showExportModal()">
                                    <i class="fas fa-download"></i>
                                    Generar Reporte Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Tickets -->
                    <div class="tickets-list-panel">
                        <div class="list-header">
                            <div class="list-title">
                                <i class="fas fa-list"></i>
                                Mis Novedades Recientes
                            </div>
                            <div class="ticket-filters">
                                <button class="filter-btn active" data-filter="all">Todos</button>
                                <button class="filter-btn" data-filter="high">Alta</button>
                                <button class="filter-btn" data-filter="medium">Media</button>
                                <button class="filter-btn" data-filter="low">Baja</button>
                                <button class="export-btn" onclick="ticketSystem.showExportModal()">
                                    <i class="fas fa-file-excel"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>

                        <div class="tickets-list" id="ticketsList">
                            <!-- Los tickets se cargarán aquí dinámicamente -->
                            <div class="empty-state">
                                <i class="fas fa-ticket-alt"></i>
                                <h3>Cargando tickets...</h3>
                                <p>Conectando con la base de datos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Página de Estadísticas -->
            <div id="page-estadisticas" class="page">
                <div class="page-header">
                    <h1 class="page-title">Estadísticas del Sistema</h1>
                    <p class="page-subtitle">Resumen y métricas de todos tus tickets</p>
                </div>

                <div class="stats-container" id="statsContainer">
                    <!-- Las estadísticas se cargarán aquí dinámicamente -->
                </div>

                <div class="tickets-list-panel">
                    <div class="list-header">
                        <div class="list-title">
                            <i class="fas fa-chart-bar"></i>
                            Distribución de Tickets
                        </div>
                        <button class="export-btn" onclick="ticketSystem.exportToExcel('stats')">
                            <i class="fas fa-file-excel"></i>
                            Exportar Estadísticas
                        </button>
                    </div>
                    <div id="statsTicketsList">
                        <!-- Tickets para análisis se cargarán aquí -->
                    </div>
                </div>
            </div>

            <!-- Página de Pendientes -->
            <div id="page-pendientes" class="page">
                <div class="page-header">
                    <h1 class="page-title">Tickets Pendientes</h1>
                    <p class="page-subtitle">Tickets activos que requieren atención</p>
                </div>

                <div class="tickets-list-panel">
                    <div class="list-header">
                        <div class="list-title">
                            <i class="fas fa-clock"></i>
                            Pendientes por Prioridad
                        </div>
                        <button class="export-btn" onclick="ticketSystem.exportToExcel('current')">
                            <i class="fas fa-file-excel"></i>
                            Exportar Pendientes
                        </button>
                    </div>
                    <div id="pendientesList">
                        <!-- Tickets pendientes se cargarán aquí -->
                    </div>
                </div>
            </div>

            <!-- Página de Completados -->
            <div id="page-completados" class="page">
                <div class="page-header">
                    <h1 class="page-title">Tickets Completados</h1>
                    <p class="page-subtitle">Historial de tickets finalizados</p>
                </div>

                <div class="tickets-list-panel">
                    <div class="list-header">
                        <div class="list-title">
                            <i class="fas fa-check-circle"></i>
                            Tickets Finalizados
                        </div>
                        <button class="export-btn" onclick="ticketSystem.exportToExcel('current')">
                            <i class="fas fa-file-excel"></i>
                            Exportar Completados
                        </button>
                    </div>
                    <div id="completadosList">
                        <!-- Tickets completados se cargarán aquí -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN DE SUPABASE CON TUS CREDENCIALES REALES
        const SUPABASE_URL = 'https://jjcyjjeidubptzocparj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqY3lqamVpZHVicHR6b2NwYXJqIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzAzNDU0OSwiZXhwIjoyMDc4NjEwNTQ5fQ.XUSPJG7zXUZj61e_cUWq2YNbGQaHfTpV9khacb5zCjk';

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Sistema de Tickets con Supabase
        class TicketSystem {
            constructor() {
                this.tickets = [];
                this.currentFilter = 'all';
                this.isLoading = false;
                this.currentPage = 'tickets';
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadTicketsFromSupabase();
                this.updateStats();
                this.setupNavigation();
            }

            setupEventListeners() {
                // Formulario de creación
                document.getElementById('ticketForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.createTicket();
                });

                // Selector de prioridad
                document.querySelectorAll('.priority-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.priority-option').forEach(opt => {
                            opt.classList.remove('active');
                        });
                        option.classList.add('active');
                    });
                });

                // Filtros
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (!btn.classList.contains('export-btn')) {
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.filter-btn').forEach(b => {
                                if (!b.classList.contains('export-btn')) {
                                    b.classList.remove('active');
                                }
                            });
                            btn.classList.add('active');
                            this.currentFilter = btn.dataset.filter;
                            this.renderTickets();
                        });
                    }
                });

                // Modal de exportación
                document.getElementById('exportModalClose').addEventListener('click', () => {
                    this.closeExportModal();
                });

                // Cerrar modal al hacer clic fuera
                document.getElementById('exportModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('exportModal')) {
                        this.closeExportModal();
                    }
                });
            }

            setupNavigation() {
                // Navegación del sidebar
                document.querySelectorAll('.menu-item[data-page]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.getAttribute('data-page');
                        this.showPage(page);
                    });
                });

                // Botón de exportación en sidebar
                document.getElementById('exportBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showExportModal();
                });
            }

            showPage(pageName) {
                // Actualizar menú activo
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

                // Ocultar todas las páginas
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                // Mostrar página seleccionada
                document.getElementById(`page-${pageName}`).classList.add('active');

                // Actualizar título principal
                const titles = {
                    'tickets': 'Sistema de Tickets',
                    'estadisticas': 'Estadísticas',
                    'pendientes': 'Tickets Pendientes',
                    'completados': 'Tickets Completados'
                };
                document.getElementById('mainTitle').textContent = titles[pageName] || 'Sistema de Tickets';

                this.currentPage = pageName;
                this.updatePageContent();
            }

            updatePageContent() {
                switch(this.currentPage) {
                    case 'estadisticas':
                        this.renderStats();
                        break;
                    case 'pendientes':
                        this.renderPendientes();
                        break;
                    case 'completados':
                        this.renderCompletados();
                        break;
                    default:
                        this.renderTickets();
                }
            }

            async loadTicketsFromSupabase() {
                this.showLoadingState();
                
                try {
                    const { data, error } = await supabase
                        .from('tickets')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) {
                        throw error;
                    }

                    this.tickets = data || [];
                    this.updatePageContent();
                    this.updateConnectionStatus(true);
                    
                } catch (error) {
                    console.error('Error cargando tickets:', error);
                    this.showNotification('Error de conexión', 'No se pudieron cargar los tickets. Usando almacenamiento local.', 'error');
                    this.loadFromLocalStorage();
                    this.updateConnectionStatus(false);
                } finally {
                    this.hideLoadingState();
                }
            }

            async createTicket() {
                if (this.isLoading) return;

                const title = document.getElementById('ticketTitle').value;
                const description = document.getElementById('ticketDescription').value;
                const priority = document.querySelector('.priority-option.active').dataset.priority;

                if (!title || !description) {
                    this.showNotification('Completa los campos', 'Por favor llena tanto el título como la descripción', 'error');
                    return;
                }

                this.setLoadingState(true);

                const ticketData = {
                    title,
                    description,
                    priority,
                    status: 'active',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                try {
                    // Intentar guardar en Supabase
                    const { data, error } = await supabase
                        .from('tickets')
                        .insert([ticketData])
                        .select();

                    if (error) {
                        throw error;
                    }

                    const newTicket = data[0];
                    this.tickets.unshift(newTicket);
                    this.saveToLocalStorage();
                    this.updatePageContent();
                    this.updateStats();
                    this.resetForm();
                    
                    this.showNotification('¡Ticket creado!', 'Tu novedad ha sido registrada en la base de datos', 'success');
                    
                } catch (error) {
                    console.error('Error creando ticket:', error);
                    // Fallback a localStorage
                    this.createTicketLocal(title, description, priority);
                } finally {
                    this.setLoadingState(false);
                }
            }

            createTicketLocal(title, description, priority) {
                const ticket = {
                    id: Date.now(),
                    title,
                    description,
                    priority,
                    status: 'active',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                this.tickets.unshift(ticket);
                this.saveToLocalStorage();
                this.updatePageContent();
                this.updateStats();
                this.resetForm();
                
                this.showNotification('Ticket creado (local)', 'Tu novedad ha sido guardada localmente', 'warning');
            }

            async deleteTicket(ticketId) {
                if (!confirm('¿Estás seguro de que quieres eliminar este ticket? Esta acción no se puede deshacer.')) {
                    return;
                }

                try {
                    // Intentar eliminar de Supabase
                    const { error } = await supabase
                        .from('tickets')
                        .delete()
                        .eq('id', ticketId);

                    if (error) {
                        throw error;
                    }

                    this.tickets = this.tickets.filter(ticket => ticket.id !== ticketId);
                    this.saveToLocalStorage();
                    this.updatePageContent();
                    this.updateStats();
                    
                    this.showNotification('Ticket eliminado', 'La novedad ha sido eliminada de la base de datos', 'success');
                    
                } catch (error) {
                    console.error('Error eliminando ticket:', error);
                    // Fallback a localStorage
                    this.tickets = this.tickets.filter(ticket => ticket.id !== ticketId);
                    this.saveToLocalStorage();
                    this.updatePageContent();
                    this.updateStats();
                    this.showNotification('Ticket eliminado (local)', 'La novedad ha sido eliminada localmente', 'warning');
                }
            }

            async updateTicketStatus(ticketId, newStatus) {
                try {
                    const { error } = await supabase
                        .from('tickets')
                        .update({ 
                            status: newStatus,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', ticketId);

                    if (error) throw error;

                    const ticketIndex = this.tickets.findIndex(t => t.id === ticketId);
                    if (ticketIndex !== -1) {
                        this.tickets[ticketIndex].status = newStatus;
                        this.tickets[ticketIndex].updated_at = new Date().toISOString();
                        this.saveToLocalStorage();
                        this.updatePageContent();
                        this.updateStats();
                    }
                    
                    this.showNotification('Ticket actualizado', `Ticket marcado como ${newStatus === 'completed' ? 'completado' : 'activo'}`, 'success');
                    
                } catch (error) {
                    console.error('Error actualizando ticket:', error);
                    this.showNotification('Error', 'No se pudo actualizar el ticket', 'error');
                }
            }

            showExportModal() {
                document.getElementById('exportModal').classList.add('active');
            }

            closeExportModal() {
                document.getElementById('exportModal').classList.remove('active');
            }

            exportToExcel(type = 'all') {
                let dataToExport = [];
                let fileName = '';

                switch(type) {
                    case 'all':
                        dataToExport = this.tickets;
                        fileName = `Reporte_Completo_Tickets_${this.getFormattedDate()}`;
                        break;
                    case 'current':
                        if (this.currentPage === 'pendientes') {
                            dataToExport = this.tickets.filter(ticket => ticket.status === 'active');
                            fileName = `Reporte_Pendientes_${this.getFormattedDate()}`;
                        } else if (this.currentPage === 'completados') {
                            dataToExport = this.tickets.filter(ticket => ticket.status === 'completed');
                            fileName = `Reporte_Completados_${this.getFormattedDate()}`;
                        } else {
                            dataToExport = this.currentFilter === 'all' 
                                ? this.tickets 
                                : this.tickets.filter(ticket => ticket.priority === this.currentFilter);
                            fileName = `Reporte_Filtrado_${this.currentFilter}_${this.getFormattedDate()}`;
                        }
                        break;
                    case 'stats':
                        dataToExport = this.generateStatsData();
                        fileName = `Reporte_Estadisticas_${this.getFormattedDate()}`;
                        break;
                }

                this.generateExcelFile(dataToExport, fileName, type);
                this.closeExportModal();
                this.showNotification('Reporte generado', `El archivo ${fileName}.xlsx se ha descargado correctamente`, 'success');
            }

            generateExcelFile(data, fileName, type) {
                const wb = XLSX.utils.book_new();

                if (type === 'stats') {
                    // Hoja de estadísticas con diseño mejorado
                    const statsData = [
                        ['REPORTE ESTADÍSTICO - OLAND SEGUROS'],
                        ['Sistema de Gestión de Tickets'],
                        [''],
                        ['Fecha de generación:', new Date().toLocaleDateString('es-ES')],
                        ['Hora de generación:', new Date().toLocaleTimeString('es-ES')],
                        [''],
                        ['RESUMEN GENERAL'],
                        ['Total de tickets:', data.totalTickets],
                        ['Tickets activos:', data.activeTickets],
                        ['Tickets completados:', data.completedTickets],
                        ['Tasa de completación:', data.completionRate + '%'],
                        [''],
                        ['DISTRIBUCIÓN POR PRIORIDAD'],
                        ['Prioridad Alta:', data.highPriority, `${data.highPercentage}%`],
                        ['Prioridad Media:', data.mediumPriority, `${data.mediumPercentage}%`],
                        ['Prioridad Baja:', data.lowPriority, `${data.lowPercentage}%`],
                        [''],
                        ['ACTIVIDAD RECIENTE'],
                        ['Tickets últimos 7 días:', data.lastWeekTickets],
                        ['Tickets último mes:', data.lastMonthTickets],
                        ['Ticket más antiguo:', data.oldestTicket],
                        ['Ticket más reciente:', data.newestTicket]
                    ];

                    const ws = XLSX.utils.aoa_to_sheet(statsData);
                    
                    // Estilos para las celdas
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cell_address = {c:C, r:R};
                            const cell_ref = XLSX.utils.encode_cell(cell_address);
                            if (!ws[cell_ref]) continue;
                            
                            // Estilo para encabezados
                            if (R === 0 || R === 6 || R === 12 || R === 19) {
                                ws[cell_ref].s = {
                                    font: { bold: true, color: { rgb: "FFFFFF" } },
                                    fill: { fgColor: { rgb: "0B2240" } },
                                    alignment: { horizontal: "center" }
                                };
                            }
                        }
                    }

                    ws['!cols'] = [{wch: 25}, {wch: 15}, {wch: 10}];
                    XLSX.utils.book_append_sheet(wb, ws, "Estadísticas");

                } else {
                    // Hoja principal de tickets con diseño profesional
                    const formattedData = data.map(ticket => ({
                        'ID': ticket.id,
                        'Título': ticket.title,
                        'Descripción': ticket.description,
                        'Prioridad': this.getPriorityText(ticket.priority),
                        'Estado': ticket.status === 'active' ? 'Activo' : 'Completado',
                        'Fecha Creación': new Date(ticket.created_at).toLocaleDateString('es-ES'),
                        'Hora Creación': new Date(ticket.created_at).toLocaleTimeString('es-ES'),
                        'Última Actualización': new Date(ticket.updated_at).toLocaleDateString('es-ES'),
                        'Días Transcurridos': Math.floor((new Date() - new Date(ticket.created_at)) / (1000 * 60 * 60 * 24))
                    }));

                    const ws = XLSX.utils.json_to_sheet(formattedData);
                    
                    // Agregar encabezado con estilo
                    XLSX.utils.sheet_add_aoa(ws, [['REPORTE DE TICKETS - OLAND SEGUROS']], { origin: 'A1' });
                    XLSX.utils.sheet_add_aoa(ws, [['Sistema de Gestión de Novedades']], { origin: 'A2' });
                    XLSX.utils.sheet_add_aoa(ws, [[`Generado el: ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}`]], { origin: 'A3' });
                    XLSX.utils.sheet_add_aoa(ws, [['']], { origin: 'A4' });
                    XLSX.utils.sheet_add_aoa(ws, [Object.keys(formattedData[0])], { origin: 'A5' });

                    const colWidths = [
                        { wch: 8 },  // ID
                        { wch: 35 }, // Título
                        { wch: 50 }, // Descripción
                        { wch: 12 }, // Prioridad
                        { wch: 12 }, // Estado
                        { wch: 15 }, // Fecha Creación
                        { wch: 15 }, // Hora Creación
                        { wch: 20 }, // Última Actualización
                        { wch: 15 }  // Días Transcurridos
                    ];
                    ws['!cols'] = colWidths;

                    XLSX.utils.book_append_sheet(wb, ws, "Tickets");
                    this.addSummarySheet(wb, data);
                }

                XLSX.writeFile(wb, `${fileName}.xlsx`);
            }

            addSummarySheet(wb, data) {
                const totalTickets = data.length;
                const activeTickets = data.filter(t => t.status === 'active').length;
                const completedTickets = data.filter(t => t.status === 'completed').length;
                const highPriority = data.filter(t => t.priority === 'high').length;
                const mediumPriority = data.filter(t => t.priority === 'medium').length;
                const lowPriority = data.filter(t => t.priority === 'low').length;

                const summaryData = [
                    ['RESUMEN EJECUTIVO - OLAND SEGUROS'],
                    [''],
                    ['INFORMACIÓN GENERAL'],
                    ['Fecha de generación:', new Date().toLocaleDateString('es-ES')],
                    ['Hora de generación:', new Date().toLocaleTimeString('es-ES')],
                    ['Total de tickets en reporte:', totalTickets],
                    [''],
                    ['ESTADO DE TICKETS'],
                    ['Tickets activos:', activeTickets],
                    ['Tickets completados:', completedTickets],
                    ['Tasa de completación:', totalTickets > 0 ? `${((completedTickets / totalTickets) * 100).toFixed(1)}%` : '0%'],
                    [''],
                    ['DISTRIBUCIÓN POR PRIORIDAD'],
                    ['🔴 Prioridad Alta:', highPriority, totalTickets > 0 ? `${((highPriority / totalTickets) * 100).toFixed(1)}%` : '0%'],
                    ['🟡 Prioridad Media:', mediumPriority, totalTickets > 0 ? `${((mediumPriority / totalTickets) * 100).toFixed(1)}%` : '0%'],
                    ['🟢 Prioridad Baja:', lowPriority, totalTickets > 0 ? `${((lowPriority / totalTickets) * 100).toFixed(1)}%` : '0%'],
                    [''],
                    ['ANÁLISIS TEMPORAL'],
                    ['Ticket más antiguo:', data.length > 0 ? new Date(data[data.length-1].created_at).toLocaleDateString('es-ES') : 'N/A'],
                    ['Ticket más reciente:', data.length > 0 ? new Date(data[0].created_at).toLocaleDateString('es-ES') : 'N/A'],
                    ['Promedio de días activos:', data.length > 0 ? Math.floor(data.reduce((acc, ticket) => acc + Math.floor((new Date() - new Date(ticket.created_at)) / (1000 * 60 * 60 * 24)), 0) / data.length) : 'N/A']
                ];

                const ws = XLSX.utils.aoa_to_sheet(summaryData);
                ws['!cols'] = [{ wch: 30 }, { wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws, "Resumen Ejecutivo");
            }

            generateStatsData() {
                const totalTickets = this.tickets.length;
                const activeTickets = this.tickets.filter(t => t.status === 'active').length;
                const completedTickets = this.tickets.filter(t => t.status === 'completed').length;
                const highPriority = this.tickets.filter(t => t.priority === 'high').length;
                const mediumPriority = this.tickets.filter(t => t.priority === 'medium').length;
                const lowPriority = this.tickets.filter(t => t.priority === 'low').length;
                
                const today = new Date();
                const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const lastMonth = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                const lastWeekTickets = this.tickets.filter(t => new Date(t.created_at) > lastWeek).length;
                const lastMonthTickets = this.tickets.filter(t => new Date(t.created_at) > lastMonth).length;

                return {
                    totalTickets,
                    activeTickets,
                    completedTickets,
                    completionRate: totalTickets > 0 ? ((completedTickets / totalTickets) * 100).toFixed(1) : 0,
                    highPriority,
                    mediumPriority,
                    lowPriority,
                    highPercentage: totalTickets > 0 ? ((highPriority / totalTickets) * 100).toFixed(1) : 0,
                    mediumPercentage: totalTickets > 0 ? ((mediumPriority / totalTickets) * 100).toFixed(1) : 0,
                    lowPercentage: totalTickets > 0 ? ((lowPriority / totalTickets) * 100).toFixed(1) : 0,
                    lastWeekTickets,
                    lastMonthTickets,
                    oldestTicket: totalTickets > 0 ? new Date(this.tickets[this.tickets.length-1].created_at).toLocaleDateString('es-ES') : 'N/A',
                    newestTicket: totalTickets > 0 ? new Date(this.tickets[0].created_at).toLocaleDateString('es-ES') : 'N/A'
                };
            }

            renderStats() {
                const stats = this.generateStatsData();
                const container = document.getElementById('statsContainer');
                
                container.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="stat-value">${stats.totalTickets}</div>
                        <div class="stat-label">Total de Tickets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-value">${stats.activeTickets}</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value">${stats.completedTickets}</div>
                        <div class="stat-label">Completados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-value">${stats.completionRate}%</div>
                        <div class="stat-label">Tasa de Completación</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-value">${stats.highPriority}</div>
                        <div class="stat-label">Alta Prioridad</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-minus-circle"></i>
                        </div>
                        <div class="stat-value">${stats.mediumPriority}</div>
                        <div class="stat-label">Media Prioridad</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="stat-value">${stats.lowPriority}</div>
                        <div class="stat-label">Baja Prioridad</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="stat-value">${stats.lastWeekTickets}</div>
                        <div class="stat-label">Última Semana</div>
                    </div>
                `;

                // Mostrar algunos tickets para análisis
                const statsList = document.getElementById('statsTicketsList');
                const recentTickets = this.tickets.slice(0, 5);
                
                if (recentTickets.length === 0) {
                    statsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-bar"></i>
                            <h3>No hay datos para mostrar</h3>
                            <p>Crea algunos tickets para ver las estadísticas</p>
                        </div>
                    `;
                    return;
                }

                statsList.innerHTML = recentTickets.map(ticket => `
                    <div class="ticket-card ${ticket.priority} ${ticket.status === 'completed' ? 'completed' : ''}">
                        <div class="ticket-header">
                            <div>
                                <div class="ticket-title">${ticket.title}</div>
                                <div style="font-size: 0.8rem; color: var(--dark-gray);">
                                    <i class="far fa-calendar"></i>
                                    ${new Date(ticket.created_at).toLocaleDateString('es-ES')}
                                </div>
                            </div>
                            <span class="ticket-priority ${this.getPriorityClass(ticket.priority)}">
                                ${this.getPriorityText(ticket.priority)}
                            </span>
                        </div>
                        <div class="ticket-description">${ticket.description}</div>
                        <div class="ticket-footer">
                            <div class="ticket-date">
                                <i class="far fa-clock"></i>
                                ${ticket.status === 'active' ? 'Activo' : 'Completado'} • 
                                Creado hace ${this.getTimeAgo(ticket.created_at)}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            renderPendientes() {
                const container = document.getElementById('pendientesList');
                const pendingTickets = this.tickets.filter(ticket => ticket.status === 'active');

                if (pendingTickets.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>¡No hay pendientes!</h3>
                            <p>Todos los tickets están completados</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = pendingTickets.map(ticket => `
                    <div class="ticket-card ${ticket.priority}">
                        <div class="ticket-header">
                            <div>
                                <div class="ticket-title">${ticket.title}</div>
                                <div style="font-size: 0.8rem; color: var(--dark-gray);">
                                    <i class="far fa-calendar"></i>
                                    ${new Date(ticket.created_at).toLocaleDateString('es-ES', { 
                                        day: 'numeric', 
                                        month: 'short',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}
                                </div>
                            </div>
                            <span class="ticket-priority ${this.getPriorityClass(ticket.priority)}">
                                ${this.getPriorityText(ticket.priority)}
                            </span>
                        </div>
                        <div class="ticket-description">${ticket.description}</div>
                        <div class="ticket-footer">
                            <div class="ticket-date">
                                <i class="far fa-clock"></i>
                                Pendiente hace ${this.getTimeAgo(ticket.created_at)}
                            </div>
                            <div class="ticket-actions">
                                <button class="action-btn" onclick="event.stopPropagation(); ticketSystem.updateTicketStatus(${ticket.id}, 'completed')" title="Marcar como completado">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); ticketSystem.deleteTicket(${ticket.id})" title="Eliminar ticket">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            renderCompletados() {
                const container = document.getElementById('completadosList');
                const completedTickets = this.tickets.filter(ticket => ticket.status === 'completed');

                if (completedTickets.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-history"></i>
                            <h3>No hay completados</h3>
                            <p>Los tickets completados aparecerán aquí</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = completedTickets.map(ticket => `
                    <div class="ticket-card ${ticket.priority} completed">
                        <div class="ticket-header">
                            <div>
                                <div class="ticket-title">${ticket.title}</div>
                                <div style="font-size: 0.8rem; color: var(--dark-gray);">
                                    <i class="far fa-calendar"></i>
                                    Completado: ${new Date(ticket.updated_at).toLocaleDateString('es-ES')}
                                </div>
                            </div>
                            <span class="ticket-priority ${this.getPriorityClass(ticket.priority)}">
                                ${this.getPriorityText(ticket.priority)}
                            </span>
                        </div>
                        <div class="ticket-description">${ticket.description}</div>
                        <div class="ticket-footer">
                            <div class="ticket-date">
                                <i class="far fa-clock"></i>
                                Completado hace ${this.getTimeAgo(ticket.updated_at)}
                            </div>
                            <div class="ticket-actions">
                                <button class="action-btn" onclick="event.stopPropagation(); ticketSystem.updateTicketStatus(${ticket.id}, 'active')" title="Reactivar ticket">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); ticketSystem.deleteTicket(${ticket.id})" title="Eliminar ticket">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            renderTickets() {
                const container = document.getElementById('ticketsList');
                const filteredTickets = this.currentFilter === 'all' 
                    ? this.tickets 
                    : this.tickets.filter(ticket => ticket.priority === this.currentFilter);

                if (filteredTickets.length === 0) {
                    let message = '';
                    let icon = 'fas fa-ticket-alt';
                    
                    if (this.tickets.length === 0) {
                        message = 'Comienza creando tu primera novedad usando el formulario de la izquierda.';
                        icon = 'fas fa-rocket';
                    } else if (this.currentFilter !== 'all') {
                        message = `No hay tickets con prioridad ${this.getPriorityText(this.currentFilter).toLowerCase()}.`;
                        icon = 'fas fa-filter';
                    } else {
                        message = 'No hay tickets registrados aún.';
                    }

                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="${icon}"></i>
                            <h3>${this.tickets.length === 0 ? '¡Bienvenido!' : 'No se encontraron tickets'}</h3>
                            <p>${message}</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredTickets.map(ticket => `
                    <div class="ticket-card ${ticket.priority} ${ticket.status === 'completed' ? 'completed' : ''}" onclick="ticketSystem.viewTicket(${ticket.id})">
                        <div class="ticket-header">
                            <div>
                                <div class="ticket-title">${ticket.title}</div>
                                <div style="font-size: 0.8rem; color: var(--dark-gray);">
                                    <i class="far fa-calendar"></i>
                                    ${new Date(ticket.created_at).toLocaleDateString('es-ES', { 
                                        day: 'numeric', 
                                        month: 'short',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}
                                </div>
                            </div>
                            <span class="ticket-priority ${this.getPriorityClass(ticket.priority)}">
                                ${this.getPriorityText(ticket.priority)}
                            </span>
                        </div>
                        <div class="ticket-description">${ticket.description}</div>
                        <div class="ticket-footer">
                            <div class="ticket-date">
                                <i class="far fa-clock"></i>
                                ${ticket.status === 'active' ? 'Creado hace' : 'Completado hace'} ${this.getTimeAgo(ticket.status === 'active' ? ticket.created_at : ticket.updated_at)}
                            </div>
                            <div class="ticket-actions">
                                <button class="action-btn" onclick="event.stopPropagation(); ticketSystem.updateTicketStatus(${ticket.id}, '${ticket.status === 'active' ? 'completed' : 'active'}')" title="${ticket.status === 'active' ? 'Completar' : 'Reactivar'}">
                                    <i class="fas ${ticket.status === 'active' ? 'fa-check' : 'fa-redo'}"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); ticketSystem.deleteTicket(${ticket.id})" title="Eliminar ticket">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            getFormattedDate() {
                const now = new Date();
                return `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            }

            getPriorityText(priority) {
                const priorities = {
                    'low': 'Baja',
                    'medium': 'Media',
                    'high': 'Alta'
                };
                return priorities[priority] || 'Media';
            }

            getPriorityClass(priority) {
                return `priority-${priority}`;
            }

            getTimeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'unos segundos';
                if (diffMins < 60) return `${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
                if (diffHours < 24) return `${diffHours} hora${diffHours > 1 ? 's' : ''}`;
                if (diffDays < 30) return `${diffDays} día${diffDays > 1 ? 's' : ''}`;
                
                const diffMonths = Math.floor(diffDays / 30);
                if (diffMonths < 12) return `${diffMonths} mes${diffMonths > 1 ? 'es' : ''}`;
                
                const diffYears = Math.floor(diffMonths / 12);
                return `${diffYears} año${diffYears > 1 ? 's' : ''}`;
            }

            viewTicket(ticketId) {
                const ticket = this.tickets.find(t => t.id === ticketId);
                if (!ticket) return;

                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 2000;
                    animation: fadeIn 0.3s ease-out;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; animation: slideIn 0.3s ease-out;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: var(--primary-dark-blue);">Detalles del Ticket</h3>
                            <button onclick="this.closest('div[style]').parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--dark-gray);">&times;</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--dark-gray);">Título:</strong>
                            <div style="margin-top: 5px; font-size: 1.1rem;">${ticket.title}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--dark-gray);">Descripción:</strong>
                            <div style="margin-top: 5px; background: var(--light-gray); padding: 15px; border-radius: 8px; white-space: pre-wrap;">${ticket.description}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                            <div>
                                <strong style="color: var(--dark-gray);">Prioridad:</strong>
                                <div style="margin-top: 5px;">
                                    <span class="ticket-priority ${this.getPriorityClass(ticket.priority)}">
                                        ${this.getPriorityText(ticket.priority)}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <strong style="color: var(--dark-gray);">Estado:</strong>
                                <div style="margin-top: 5px;">
                                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; background: ${ticket.status === 'active' ? 'var(--success)' : 'var(--dark-gray)'}; color: white;">
                                        ${ticket.status === 'active' ? 'Activo' : 'Completado'}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <strong style="color: var(--dark-gray);">Fecha creación:</strong>
                                <div style="margin-top: 5px;">${new Date(ticket.created_at).toLocaleString('es-ES')}</div>
                            </div>
                            <div>
                                <strong style="color: var(--dark-gray);">Última actualización:</strong>
                                <div style="margin-top: 5px;">${new Date(ticket.updated_at).toLocaleString('es-ES')}</div>
                            </div>
                        </div>
                        <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="ticketSystem.updateTicketStatus(${ticket.id}, '${ticket.status === 'active' ? 'completed' : 'active'}'); this.closest('div[style]').parentElement.remove()" class="btn ${ticket.status === 'active' ? 'btn-success' : 'btn-primary'}" style="padding: 10px 20px;">
                                <i class="fas ${ticket.status === 'active' ? 'fa-check' : 'fa-redo'}"></i>
                                ${ticket.status === 'active' ? 'Marcar como Completado' : 'Reactivar Ticket'}
                            </button>
                            <button onclick="ticketSystem.deleteTicket(${ticket.id}); this.closest('div[style]').parentElement.remove()" class="btn" style="padding: 10px 20px; background: var(--danger); color: white;">
                                <i class="fas fa-trash"></i>
                                Eliminar
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            updateStats() {
                const totalTickets = this.tickets.length;
                const pendingTickets = this.tickets.filter(t => t.status === 'active').length;
                const completedTickets = this.tickets.filter(t => t.status === 'completed').length;

                document.getElementById('ticketsCount').textContent = totalTickets;
                document.getElementById('pendientesCount').textContent = pendingTickets;
                document.getElementById('completadosCount').textContent = completedTickets;
            }

            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                if (connected) {
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: var(--success); font-size: 0.7rem;"></i> Conectado a Supabase';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: var(--warning); font-size: 0.7rem;"></i> Modo local (sin conexión)';
                }
            }

            resetForm() {
                document.getElementById('ticketForm').reset();
                document.querySelectorAll('.priority-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                document.querySelector('.priority-option.medium').classList.add('active');
            }

            setLoadingState(loading) {
                this.isLoading = loading;
                const submitBtn = document.getElementById('submitBtn');
                
                if (loading) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="loading"></div> Procesando...';
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Crear Ticket';
                }
            }

            showLoadingState() {
                const containers = ['ticketsList', 'pendientesList', 'completadosList', 'statsTicketsList'];
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="loading" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 20px auto;"></div>
                                <h3>Cargando tickets...</h3>
                                <p>Conectando con la base de datos</p>
                            </div>
                        `;
                    }
                });
            }

            hideLoadingState() {
                // El render se encargará de actualizar la vista
            }

            saveToLocalStorage() {
                localStorage.setItem('tickets_backup', JSON.stringify(this.tickets));
            }

            loadFromLocalStorage() {
                const backup = localStorage.getItem('tickets_backup');
                if (backup) {
                    this.tickets = JSON.parse(backup);
                    this.updatePageContent();
                    this.updateStats();
                }
            }

            showNotification(title, message, type = 'success') {
                const notification = document.getElementById('notification');
                const notificationTitle = document.getElementById('notification-title');
                const notificationText = document.getElementById('notification-text');
                
                notificationTitle.textContent = title;
                notificationText.textContent = message;
                
                notification.className = 'notification';
                notification.classList.add(type);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }
        }

        // Inicializar el sistema cuando se carga la página
        let ticketSystem;
        document.addEventListener('DOMContentLoaded', () => {
            ticketSystem = new TicketSystem();
        });
    </script>
</body>
</html>
